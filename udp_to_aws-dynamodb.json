{
  "templateDef": [
    {
      "name": "UDP Port",
      "key": "udp_port",
      "desc": "UDP port assigned by IoT Bridge.",
      "value": "<port>"
    },
    {
      "name": "DynamoDB Region",
      "key": "aws_region",
      "desc": "Region of your DynamoDB table.",
      "value": "us-east-2"
    },
    {
      "name": "DynamoDB Table Name",
      "key": "dynamodb_table_name",
      "desc": "Table name to put UDP records.",
      "value": "iotb-udp-records"
    },
    {
      "name": "Create role via Cloud Formation",
      "key": "cloudformation",
      "desc": "Import cloud formation template to create AWS role.",
      "stackName": "IoTBridge-Access",
      "stackS3Url" : "https://tartabit-cf-templates.s3.us-east-2.amazonaws.com/iotb-cross-role-v1.yaml",
      "stackParams": {
        "AllowExternalId": "$aws_assume_external_id",
        "AllowAccountId": "$aws_account_id"
      }
    },
    {
      "name": "AWS Cross-Account Role",
      "key": "aws_assume_role_arn",
      "desc": "Role generated by cloud formation template.",
      "value": "<role arn from previous step>"
    },
    {
      "name": "AWS Cross-Account Role ExternalId",
      "key": "aws_assume_external_id",
      "desc": "External ID used to authenticate AWS cross-account role.",
      "genString": 12
    }
  ],
  "services": [
    {
      "id": "65be7350e5af238bf7b9395c",
      "name": "DynamoDB",
      "key": "dynamodb",
      "modelId": "81db3f490d2b5b4dabf22a3e",
      "params": {
        "access_method": "Assume Role",
        "assume_external_id": "{{.aws_assume_external_id}}",
        "assume_role_arn": "{{.aws_assume_role_arn}}",
        "region": "{{.dynamodb_region}}"
      }
    },
    {
      "id": "65be7334e5af238bf7b9395b",
      "name": "UDP Receiver",
      "key": "udp_receiver",
      "modelId": "81418d0e1607815e03483843",
      "params": {
        "port": "{{.udp_port}}"
      }
    }
  ],
  "triggers": [
    {
      "id": "65c10fe1e121e01b53f433ad",
      "name": "DynamoDB - Create table",
      "type": "script",
      "def": "aws_dynamodb.create_table('dynamodb','{{.dynamodb_table_name}}',{partitionkey:'txnId'})",
      "filterType": "once-event"
    },
    {
      "id": "65be741e973d5e4805de7338",
      "name": "DynamoDB - Put Packets",
      "type": "script",
      "def": "aws_dynamodb.put('dynamodb','{{.dynamodb_table_name}}',{txnId: event.id, remoteAddr: event.data.remoteAddr, ts: event.ts, payload: event.data.payload})",
      "filterType": "udp-receive"
    }
  ]
}
