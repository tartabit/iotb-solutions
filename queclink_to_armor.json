{
  "templateDef": [
    {
      "name": "ARMOR URL",
      "key": "armor_url",
      "desc": "The URL for your ARMOR server.",
      "value": "https://app.armordata.io"
    },
    {
      "name": "ARMOR API Token",
      "key": "armor_token",
      "desc": "An API token for your ARMOR account.",
      "value": "AT:********************"
    }
  ],
  "services": [
    {
      "id": "697cff434ed73d34a1952b48",
      "key": "queclink-armor",
      "modelId": "8179d1d5feb8a2d8971b7c41",
      "name": "Queclink - ARMOR",
      "params": {
        "access_token": "{{.armor_token}}",
        "armor_url": "{{.armor_url}}",
        "tls_skip_verification": "false"
      }
    }
  ],
  "triggers": [
    {
      "def": "\r\narmor.publish('queclink-armor', event.endpoint.key, event.data.data.event, event.data.data.properties, event.data.data.values, {ts: event.data.data.ts, loc: event.data.data.loc, locSource: event.data.data.locSource})",
      "filterGeneric": "armor-received",
      "filterType": "generic",
      "id": "697cffd7c434fb56260effc7",
      "name": "Queclink - ASCII - Send to ARMOR",
      "rateLimit": {
        "scope": "none",
        "unit": "minute"
      },
      "type": "script"
    },
    {
      "def": "// block duplicated packets unless injected\r\nif(!event.injected) {\r\n    if(!trigger.ratelimit('dupe:'+event.data.data.key+':'+event.data.data.seq + ':' + event.data.data.ts,1,1,43200)) {\r\n        trigger.exit()\r\n    }\r\n}\r\n\r\n// get the current metadata for the endpoint\r\nvar metaCurrent = endpoint.storageGet(event.endpoint.key,'armor-meta')\r\nif(!metaCurrent) {\r\n    metaCurrent = {\r\n        externalVoltage: -1,\r\n        externalVoltageMax: 0,\r\n        externalVoltageDecreaseCount: 0,\r\n        charging: false,\r\n        running: false,\r\n        input0: false,\r\n        input1: false,\r\n        disconnected: false,\r\n    }\r\n}\r\n// copy the metadata for the \"new\" metadata after the packet\r\nvar metaNew = Object.assign({}, metaCurrent)\r\n\r\nvar armorType = 'Armor ?'\r\nvar armorCharging = false\r\nvar assetCharging = true\r\narmorType = event.data.data.deviceType\r\nswitch(event.data.data.deviceType) {\r\n    case 'GL521MG':\r\n    case 'GL33':\r\n        armorCharging = true\r\n        break\r\n    default:\r\n        break\r\n}\r\n\r\nvar recentDog = false\r\nif (metaCurrent.dogTs) {\r\n    var dogTs = date.parse(metaCurrent.dogTs,'rfc3339')\r\n    var curTs = date.parse(event.data.data.ts,'rfc3339')\r\n    var diff = (curTs - dogTs) / 60000\r\n    if (diff < 5) {\r\n        recentDog = true\r\n        log.trace('recentDog: detected', { meta: metaCurrent, diff: diff })\r\n    } else {\r\n        log.trace('recentDog: detected but expired', { meta: metaCurrent, diff: diff })\r\n        delete metaNew.dogTs\r\n    }\r\n}\r\n\r\nvar baseMsg = {\r\n    txnId: event.id,\r\n    event: 'unknown',\r\n    deviceId: event.data.data.key,\r\n    ts: event.data.data.ts,\r\n    values: {},\r\n    properties: {\r\n        armorType: armorType,\r\n    },\r\n    notes: []\r\n}\r\n\r\n// added raw, can be removed later\r\nbaseMsg.internal = {raw: event.data.data.raw}\r\n\r\n// base data cleanup\r\n\r\nif(event.data.data.net) {\r\n  try {\r\n    var network = convert.mccmnc(event.data.data.net.mcc,event.data.data.net.mnc)\r\n    baseMsg.properties.network = network.operator;\r\n  } catch(e) {\r\n    log.warn('network lookup failed', event.data.data.net)\r\n  }\r\n}\r\n\r\nif(metaCurrent.runStart && event.data.data.ignitionOnDuration && event.data.data.ignitionOnDuration==999999) {\r\n    log.warn('event with bad ignitionOnDuration', metaCurrent)\r\n    var prevTs = date.parse(metaCurrent.runStart,'rfc3339')\r\n    var curTs = date.parse(event.data.data.ts,'rfc3339')\r\n    var diff = curTs-prevTs / 60000\r\n    if(diff>0 && diff < 600) {\r\n        baseMsg.notes.push('duration derived from previous, original: '+ event.data.data.ignitionOnDuration)\r\n        event.data.data.ignitionOnDuration = diff\r\n    } else {\r\n        baseMsg.notes.push('duration truncated, no previous found, original: '+ event.data.data.ignitionOnDuration)\r\n        event.data.data.ignitionOnDuration = 600\r\n    }\r\n}\r\n\r\nif((typeof event.data.data.externalPowerVcc !== 'undefined') && (event.data.data.externalPowerVcc !== null)) {\r\n    baseMsg.values.batteryVoltage = event.data.data.externalPowerVcc\r\n    if(event.data.data.deviceType=='GV57ARMG' && metaCurrent.externalVoltage>0) {\r\n        if(event.data.data.externalPowerVcc > metaCurrent.externalVoltageMax) {\r\n            metaNew.externalVoltageMax = event.data.data.externalPowerVcc\r\n        }\r\n    }\r\n    metaNew.externalVoltage = event.data.data.externalPowerVcc\r\n}\r\n\r\nif(event.data.data.battery) {\r\n    baseMsg.values.armorBatteryLevel = event.data.data.battery\r\n}\r\nif(event.data.data.temperature) {\r\n    baseMsg.values.temperature = (event.data.data.temperature * 3.0 / 2.0) + 32\r\n}\r\nif(event.data.data.rssi) {\r\n    baseMsg.values.rssi = event.data.data.rssi\r\n}\r\nif(event.data.data.buffered===true) {\r\n    if(event.data.data.ts.startsWith('2020')) {\r\n        baseMsg.notes.push('buffered event with invalid timestamp')\r\n        trigger.exit()\r\n    } else {\r\n        var rcvTs = date.parse(event.ts,'rfc3339')\r\n        var pktTs = date.parse(event.data.data.ts,'rfc3339')\r\n        var diff = (rcvTs-pktTs)/60000\r\n        if(diff>30) {\r\n            baseMsg.notes.push('buffered for ' + diff.toFixed(1) + ' minutes')\r\n        }\r\n    }\r\n}\r\n\r\nfunction cloneMsg() {\r\n    var newMsg = Object.assign({}, baseMsg)\r\n    newMsg.values = Object.assign({}, baseMsg.values)\r\n    newMsg.properties = Object.assign({}, baseMsg.properties)\r\n    newMsg.notes = baseMsg.notes.slice()\r\n    //log.trace('msg', newMsg)\r\n    return newMsg\r\n}\r\n\r\nvar msgs = []\r\n\r\nswitch(event.data.data.cmd) {\r\n    case 'GTCRA':\r\n        var msg = cloneMsg()\r\n        msg.event = 'crash'\r\n        msgs.push(msg)\r\n        break\r\n    case 'GTINF':\r\n        var msg = cloneMsg()\r\n        msg.event = 'status'\r\n        if(!event.data.data.rssi) {\r\n            trigger.exit()\r\n        }\r\n        msgs.push(msg)\r\n        break\r\n    case 'GTEPS':\r\n        // do nothing but handle below\r\n        break\r\n    case 'GTFRI':\r\n        var msg = cloneMsg()\r\n        if(event.data.data.reportId=='schedule') {\r\n            msg.event = 'heartbeat'\r\n        } else if(event.data.data.ignition===true) {            \r\n            msg.event = 'running'\r\n        } else if(event.data.data.motion===true) {\r\n            msg.event = 'running'\r\n        } else if(event.data.data.reportId=='time') {\r\n            msg.event = 'status' \r\n        } else if(event.data.data.deviceType!='GV57ARMG') {\r\n            msg.event = 'heartbeat'\r\n        } else {\r\n             msg.event = 'status'\r\n        }\r\n        msgs.push(msg)\r\n        break\r\n    case 'GTVGL':\r\n        var msg = cloneMsg()\r\n        if(event.data.data.ignition) {\r\n            msg.event = 'running'\r\n        } else if(event.data.data.motion) {\r\n            msg.event = 'running'\r\n        } else {\r\n            msg.event = 'status'\r\n        }\r\n        msg.notes.push('cmd: GTVGL')\r\n        msgs.push(msg)\r\n        break\r\n    case 'GTSTT':\r\n        var msg = cloneMsg()\r\n        if(event.data.data.ignition===true) {\r\n            msg.event = 'running'\r\n        } else if(!event.data.data.hasOwnProperty('ignition') && event.data.data.motion===true) {\r\n            msg.event = 'running'\r\n        } else {\r\n            //log.trace('ignoring message with event: ' + event.data.data.cmd)\r\n            trigger.exit()\r\n        }\r\n        msg.notes.push('cmd: GTSTT')\r\n        msgs.push(msg)\r\n        break\r\n    case 'GTHBM':\r\n        var msg = cloneMsg()\r\n        msg.event = 'harsh-driving'\r\n        if(event.data.data.harshType) {\r\n            msg.event = 'harsh-'+event.data.data.harshType\r\n        }\r\n        if(event.data.data.harshLevel) {\r\n            msg.values.harshLevel = event.data.data.harshLevel\r\n        }\r\n        msgs.push(msg)\r\n        break\r\n    case 'GTSTC':\r\n        if(!armorCharging) {\r\n            // only GL for now\r\n            trigger.exit()\r\n        }\r\n        metaNew.charging = false\r\n        var msg = cloneMsg()\r\n        var startDate = date.parse(metaCurrent.chargeStart,'rfc3339')\r\n        var endDate = date.parse(event.data.data.ts, 'rfc3339')\r\n        msg.values.chargeTime = (endDate - startDate) / 60000  \r\n        msg.event = 'charge-stop'\r\n        msgs.push(msg)\r\n        break\r\n    case 'GTBTC':\r\n        if(!armorCharging) {\r\n            // only GL for now\r\n            trigger.exit()\r\n        }\r\n        var msg = cloneMsg()\r\n        metaNew.chargeStart = event.data.data.ts\r\n        metaNew.charging = true\r\n        msg.event = 'charge-start'\r\n        msgs.push(msg)\r\n        break\r\n    case 'GTBPL':\r\n        // rate limit because we get 5 bpl messages\r\n        if(!trigger.ratelimit('bpl:'+event.endpoint.key,1,1,600)) {\r\n            trigger.exit()\r\n        }\r\n        var msg = cloneMsg()\r\n        msg.event = 'armor-battery-low'\r\n        msgs.push(msg)\r\n        break\r\n    case 'GTNMR':\r\n        var msg = cloneMsg()\r\n        if (!metaCurrent.running && event.data.data.motion) {\r\n            msg.event = 'run-start'\r\n            metaNew.running = true\r\n            metaNew.runStart = event.data.data.ts\r\n            metaNew.runStartTxnId = event.id\r\n            msgs.push(msg)\r\n        } else if (metaCurrent.running && !event.data.data.motion) {\r\n            msg.event = 'run-stop'\r\n            if(metaCurrent.running && metaCurrent.runStart) {\r\n                var startDate = date.parse(metaCurrent.runStart,'rfc3339')\r\n                var endDate = date.parse(event.data.data.ts, 'rfc3339')\r\n                var secs = (endDate - startDate) / 1000\r\n                msg.values.runTime = secs / 60\r\n            }\r\n            metaNew.runStop = event.data.data.ts\r\n            metaNew.runStopTxnId = event.id\r\n            metaNew.running = false\r\n            msgs.push(msg)\r\n        } else {\r\n            log.warn('invalid GTNMR state', {'meta': metaCurrent })\r\n        }\r\n        break\r\n    case 'GTPNA':\r\n        if ((event.data.data.deviceType == 'GL521MG' && event.data.data.powerOnType == 'movement')) {\r\n            trigger.exit()\r\n        }\r\n        if (!recentDog) {\r\n            var msg = cloneMsg()\r\n            msg.event = 'armor-power-on'\r\n            msgs.push(msg)\r\n        }\r\n        break\r\n    case 'GTMPF':\r\n        var msg = cloneMsg()\r\n        msg.event = 'armor-power-disconnected'\r\n        msg.values.batteryVoltage = 0.0\r\n        metaNew.disconnected = true\r\n        msgs.push(msg)\r\n        break\r\n    case 'GTMPN':\r\n        var msg = cloneMsg()\r\n        msg.event = 'armor-power-connected'\r\n        metaNew.disconnected = false\r\n        msgs.push(msg)\r\n        break\r\n    case 'GTPFA':\r\n        if (!recentDog) {\r\n            var msg = cloneMsg()\r\n            msg.event = 'armor-power-off'\r\n            msgs.push(msg) \r\n        }\r\n        break\r\n    case 'GTPNL':\r\n        trigger.exit()\r\n        break\r\n    case 'GTVGF':\r\n        var msg = cloneMsg()\r\n        msg.event = 'run-stop'\r\n        msg.values.runTime = event.data.data.ignitionOnDuration / 60\r\n        metaNew.running = false\r\n        metaNew.runStop = event.data.data.ts\r\n        metaNew.runStopTxnId = event.id\r\n        metaNew.voltageAfterRunStop = 0\r\n         msgs.push(msg)\r\n        break\r\n    case 'GTVGN':\r\n         var msg = cloneMsg()\r\n        msg.event = 'run-start'\r\n        metaNew.running = true\r\n        metaNew.runStart = event.data.data.ts\r\n        metaNew.runStartTxnId = event.id\r\n        msgs.push(msg)\r\n        break\r\n    case 'GTIDF':\r\n         var msg = cloneMsg()\r\n        msg.event = 'idle-stop'\r\n        msg.values.idleTime = event.data.data.idleDuration / 60\r\n        msgs.push(msg)\r\n        break\r\n    case 'GTIDN':\r\n        var msg = cloneMsg()\r\n        msg.event = 'idle-start'\r\n        msgs.push(msg)\r\n        break\r\n    case 'GTIGF':\r\n        if(event.data.data.deviceType==\"GV57ARMG\") {\r\n            trigger.exit()\r\n        } else {\r\n            var msg = cloneMsg()\r\n            msg.values.runTime = event.data.data.ignitionOnDuration / 60\r\n            metaNew.running = false\r\n            metaNew.runStop = event.data.data.ts\r\n            metaNew.runStopTxnId = event.id\r\n            metaNew.voltageAfterRunStop = 0\r\n            msgs.push(msg)\r\n        }\r\n        msg.event = 'run-stop'      \r\n        break\r\n    case 'GTIGN':\r\n        if(event.data.data.deviceType==\"GV57ARMG\") {\r\n            trigger.exit()\r\n        }\r\n        var msg = cloneMsg()\r\n        msg.event = 'run-start'\r\n        metaNew.running = true\r\n        metaNew.runStart = event.data.data.ts\r\n        metaNew.runStartTxnId = event.id\r\n        msgs.push(msg)\r\n        break\r\n    case 'GTDIS':\r\n        if (event.data.data.inputValue) {\r\n            if(metaCurrent['input'+event.data.data.inputNumber]) {\r\n                // if repeat in the same state, discard.\r\n                log.warn('disacrding event, input state is the same', {metaCurrent: metaCurrent, evt: event})\r\n                trigger.exit()\r\n            }\r\n            var msg = cloneMsg()\r\n            msg.event = 'input'+event.data.data.inputNumber + '-start'\r\n            msgs.push(msg)\r\n\r\n            metaNew['input'+event.data.data.inputNumber] = true\r\n\r\n            if(!metaCurrent.running) {\r\n                var msg = cloneMsg()\r\n                msg.event = 'run-start'\r\n                msgs.push(msg)\r\n                metaNew.running = true\r\n                metaNew.runStart = event.data.data.ts\r\n                metaNew.runStartTxnId = event.id\r\n            }\r\n            \r\n        } else {\r\n            if(!metaCurrent['input'+event.data.data.inputNumber]) {\r\n                // if repeat in the same state, discard.\r\n                log.warn('disacrding event, input state is the same', {metaCurrent: metaCurrent, evt: event})\r\n                trigger.exit()\r\n            }\r\n            var msg = cloneMsg()\r\n            msg.event = 'input'+event.data.data.inputNumber + '-stop'\r\n            if (!msg.values) msg.values = {}\r\n            msg.values['input'+event.data.data.inputNumber+'Time'] = event.data.data.onDuration / 60\r\n            msgs.push(msg)\r\n            \r\n            metaNew['input'+event.data.data.inputNumber] = false\r\n\r\n            if(metaCurrent.running && !metaNew.input0 && !metaNew.input1) {\r\n                metaNew.running = false\r\n                metaNew.runStop = event.data.data.ts\r\n                metaNew.voltageAfterRunStop = 0\r\n                metaNew.runStopTxnId = event.id\r\n\r\n                var msg = cloneMsg()\r\n                msg.event = 'run-stop'\r\n                var startTs = date.parse(metaNew.runStart,'rfc3339')\r\n                var stopTs = date.parse(metaNew.runStop,'rfc3339')\r\n                var diff = (stopTs-startTs)/60000\r\n                msg.values.runTime = diff\r\n                msgs.push(msg)\r\n            }\r\n        }\r\n        break\r\n    case 'GTDOG':\r\n        metaNew.dogTs = event.data.data.ts\r\n        log.trace('saving dogTs', metaNew)\r\n        break\r\n    case 'GTUPC':\r\n        if(event.data.data.otaCode==301) {\r\n            var msg = cloneMsg()\r\n            msg.event = 'cota-updated'\r\n            msgs.push(msg)\r\n        } else {\r\n            trigger.exit()\r\n        }\r\n        break\r\n    case 'GTUPD':\r\n        if(event.data.data.otaCode==301) {\r\n            var msg = cloneMsg()\r\n            msg.event = 'fota-updated'\r\n            msgs.push(msg)\r\n        } else {\r\n            trigger.exit()\r\n        }\r\n        break\r\n    default:\r\n        //log.trace('ignoring message with event: ' + event.data.data.cmd)\r\n        if (event.injected) {\r\n            log.trace('ignoring message with event: ' + event.data.data.cmd)\r\n        }\r\n        trigger.exit()\r\n        //msg.notes.push('actual event: '+ event.data.data.cmd)\r\n        break\r\n}\r\n\r\nif(metaCurrent.disconnected===true && event.data.data.externalPowerVcc > 0) {\r\n    var msg = cloneMsg()\r\n    msg.event = 'armor-power-connected'\r\n    msg.notes.push('inferred connection from voltage')\r\n    msgs.push(msg)\r\n    metaNew.disconnected=false\r\n}\r\n\r\nif(event.data.data.externalPowerVcc>=0) {\r\n    if(assetCharging && metaCurrent.charging && metaCurrent.externalVoltageMax - event.data.data.externalPowerVcc > 0.5) {\r\n        // check for decreasing values\r\n        metaNew.externalVoltageDecreaseCount = metaCurrent.externalVoltageDecreaseCount+1\r\n        if(metaNew.externalVoltageDecreaseCount>=2) {\r\n            // if 2 decreasing values, then stop the charge\r\n            var msg = cloneMsg()\r\n            msg.event = 'charge-stop'\r\n            metaNew.chargeStop = event.data.data.ts\r\n            if(!metaNew.chargeStart) {\r\n                msg.notes.push('no start time to calculate chargeTime')\r\n            } else {\r\n                var startTs = date.parse(metaNew.chargeStart,'rfc3339')\r\n                var stopTs = date.parse(metaNew.chargeStop,'rfc3339')\r\n                var diff = (stopTs-startTs)/60000\r\n                if(diff<0) {\r\n                    msg.notes.push('invalid calculated chargetime: '+diff)\r\n                }\r\n                msg.values.chargeTime = diff\r\n                msg.notes.push('reason: 2 decreasing values')\r\n            }\r\n            metaNew.voltageAfterRunStop=event.data.data.externalPowerVcc\r\n            metaNew.charging = false\r\n            msgs.push(msg)\r\n        } else if(metaCurrent.externalVoltageMax - event.data.data.externalPowerVcc > 1.5) {\r\n            // if drop is 1.5V or more then stop the charge\r\n            var msg = cloneMsg()\r\n            msg.event = 'charge-stop'\r\n            metaNew.chargeStop = event.data.data.ts\r\n            if(!metaNew.chargeStart) {\r\n                msg.notes.push('no start time to calculate chargeTime')\r\n            } else {\r\n                var startTs = date.parse(metaNew.chargeStart,'rfc3339')\r\n                var stopTs = date.parse(metaNew.chargeStop,'rfc3339')\r\n                var diff = (stopTs-startTs)/60000\r\n                if(diff<0) {\r\n                    msg.notes.push('invalid calculated chargetime: '+diff)\r\n                }\r\n                msg.values.chargeTime = diff\r\n                msg.notes.push('reason: 1.5V drop')\r\n            }\r\n            metaNew.voltageAfterRunStop=event.data.data.externalPowerVcc\r\n            metaNew.charging = false\r\n            msgs.push(msg)\r\n        } else if(msgs.length===0) {\r\n            var msg = cloneMsg()\r\n            msg.event = 'charging'\r\n            msg.notes.push('voltage delta: '+(metaCurrent.externalVoltageMax - event.data.data.externalPowerVcc))\r\n            msgs.push(msg)\r\n        }\r\n    } else if (assetCharging && metaCurrent.running && metaCurrent.charging) {\r\n        var msg = cloneMsg()\r\n        msg.event = 'charge-stop'\r\n        metaNew.chargeStop = event.data.data.ts\r\n        if(!metaNew.chargeStart) {\r\n            msg.notes.push('no start time to calculate chargeTime')\r\n        } else {\r\n            var startTs = date.parse(metaNew.chargeStart,'rfc3339')\r\n            var stopTs = date.parse(metaNew.chargeStop,'rfc3339')\r\n            var diff = (stopTs-startTs)/60000\r\n            if(diff<0) {\r\n                msg.notes.push('invalid calculated chargetime: '+diff)\r\n            }\r\n            msg.values.chargeTime = diff\r\n            msg.notes.push('reason: running while charging')\r\n        }\r\n        metaNew.voltageAfterRunStop=event.data.data.externalPowerVcc\r\n        metaNew.charging = false\r\n        msgs.push(msg)\r\n    } else if(!metaCurrent.running && metaCurrent.voltageAfterRunStop==0) {\r\n        metaNew.voltageAfterRunStop = event.data.data.externalPowerVcc\r\n        if(msgs.length===0) {\r\n            var msg = cloneMsg()\r\n            msg.event = 'status'\r\n            msgs.push(msg)\r\n        }\r\n    } else if(!metaCurrent.running && !metaCurrent.charging && metaCurrent.voltageAfterRunStop>0) {\r\n        if(assetCharging && (event.data.data.externalPowerVcc - metaCurrent.voltageAfterRunStop) > 1.0) {\r\n            var msg = cloneMsg()\r\n            msg.event = 'charge-start'\r\n            metaNew.chargeStart = event.data.data.ts\r\n            metaNew.charging = true\r\n            metaNew.externalVoltageMax = event.data.data.externalPowerVcc\r\n            metaNew.externalVoltageDecreaseCount = 0\r\n            msgs.push(msg)\r\n        } else {\r\n            if(msgs.length===0) {\r\n                var msg = cloneMsg()\r\n                msg.event = 'status'\r\n                msgs.push(msg)\r\n            }\r\n        }\r\n    } else if(metaCurrent.running) {\r\n        metaNew.externalVoltageDecreaseCount = 0\r\n        if(msgs.length===0) {\r\n            var msg = cloneMsg()\r\n            msg.event = 'running'\r\n            msgs.push(msg)\r\n        }\r\n    } else if(metaCurrent.charging) {\r\n        metaNew.externalVoltageDecreaseCount = 0\r\n        if(msgs.length===0) {\r\n            var msg = cloneMsg()\r\n            msg.event = 'charging'\r\n            msgs.push(msg)\r\n        }\r\n    } else {\r\n        metaNew.externalVoltageDecreaseCount = 0\r\n        if(msgs.length===0) {\r\n            var msg = cloneMsg()\r\n            msg.event = 'status'\r\n            msgs.push(msg)\r\n        }\r\n    }\r\n}\r\n\r\nmsgs.forEach(function (msg) {\r\n\r\n    // gps handling\r\n    var locViaWifi = false\r\n    var wifiLoc = undefined\r\n    if (event.endpoint.tags.wifiPresent == 'true') {\r\n        wifiLoc = endpoint.storageGet(event.endpoint.key, 'wifi-loc')\r\n    } else if (event.endpoint.statusDetails.wifiLocator) {\r\n        wifiLoc = endpoint.storageGet(event.endpoint.statusDetails.wifiLocator, 'wifi-loc')\r\n    }\r\n    if(wifiLoc) {\r\n        if(event.data.data.gps && event.data.data.gps.ts && event.endpoint.tags.wifiPreferred!='true') {\r\n            var wifiTs = date.parse(wifiLoc.ts,'rfc3339')\r\n            var gpsTs = date.parse(event.data.data.gps.ts,'rfc3339')\r\n            if(event.data.gps && wifiTs > gpsTs) {\r\n                locViaWifi = true\r\n            }/* else {\r\n                log.trace('wifi locator has wifi, but gps is newer')\r\n            }*/\r\n        } else {\r\n            locViaWifi = true\r\n        }\r\n        if(locViaWifi) {\r\n            msg.loc = {\r\n                type: 'Point',\r\n                coordinates: [wifiLoc.loc.lon, wifiLoc.loc.lat]\r\n            }\r\n\r\n            msg.notes.push('wifi location')\r\n            locViaWifi = true\r\n            log.trace('wifi used for location', {loc: wifiLoc, msg: msg})\r\n            msg.locSource = 'wifi'\r\n        }\r\n    }\r\n    if(locViaWifi) {\r\n        // do nothing\r\n    } else if(event.data.data.gps && \r\n        event.data.data.gps.age < 86400 && \r\n        event.data.data.gps.age >= -120 &&\r\n        event.data.data.gps.longitude && \r\n        event.data.data.gps.latitude &&\r\n        event.data.data.gps.longitude != 0.0 &&\r\n        event.data.data.gps.latitude != 0.0) {\r\n        msg.loc = {\r\n            type: 'Point',\r\n            coordinates: [event.data.data.gps.longitude, event.data.data.gps.latitude]\r\n        }\r\n        msg.locSource = 'gps'\r\n        if(msg.event=='running' && event.data.data.gps.age < 180) {\r\n            if(event.data.data.gps.speed>10) {\r\n                msg.values.speed = event.data.data.gps.speed * 0.621371\r\n                var directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];\r\n                var index = Math.round(event.data.data.gps.heading / 45) % 8;\r\n                msg.values.heading = directions[index]\r\n            }\r\n        }\r\n    } else if(event.data.data.gps && event.data.data.gps.age > 86400) {\r\n        if(event.endpoint.tags.verticalId && event.endpoint.tags.verticalId!='floorcare') {\r\n            msg.notes.push('stale gps location: '+ event.data.data.gps.age)\r\n        }\r\n    }\r\n\r\n    // mileage handling\r\n    if(msg.event == 'run-start') {\r\n        if(event.data.data.mileage && event.data.data.mileage>0) {\r\n            metaNew.runStartMileage = event.data.data.mileage\r\n        }\r\n    } else if(msg.event == 'run-stop') {\r\n        if(event.data.data.mileage && event.data.data.mileage>0) {\r\n            if(event.data.data.mileage>=metaCurrent.runStartMileage) {\r\n                msg.values.distance = (event.data.data.mileage-metaCurrent.runStartMileage) * 0.621371\r\n            } else {\r\n                msg.notes.push('mileage dropped: '+ event.data.data.mileage + '<' + metaCurrent.runStartMileage )\r\n            }\r\n        }\r\n    }\r\n\r\n    // limiting runtime\r\n    if(msg.event.endsWith('-stop')) {\r\n        var limit = 0\r\n        if(event.endpoint.tags.manufacturerId) {\r\n            limit = global.values.ngMaxRuntime[event.endpoint.tags.manufacturerId]\r\n        } else {\r\n            limit = 180\r\n        }\r\n        if(limit && limit>0) {\r\n            if (msg.event == 'run-stop') {\r\n                if(msg.values.runTime>limit) {\r\n                    msg.notes.push('limited runtime for ['+event.endpoint.tags.manufacturerId+'] from ' + msg.values.runTime + ' to '+limit)\r\n                    msg.values.runTime = limit\r\n                }\r\n            } else if (msg.event == 'input0-stop') {\r\n                if(msg.values.input0Time>limit) {\r\n                    msg.notes.push('limited runtime for ['+event.endpoint.tags.manufacturerId+'] from ' + msg.values.input0Time + ' to '+limit)\r\n                    msg.values.input0Time = limit\r\n                }\r\n            } else if (msg.event == 'input1-stop') {\r\n                if(msg.values.input1Time>limit) {\r\n                    msg.notes.push('limited runtime for ['+event.endpoint.tags.manufacturerId+'] from ' + msg.values.input1Time + ' to '+limit)\r\n                    msg.values.input1Time = limit\r\n                    log.trace('limited runtime i1', {msg: msg, evt: event, metaNew: metaNew, metaCurrent: metaCurrent})\r\n                }\r\n            }\r\n        }\r\n    }\r\n    if (event.injected) {\r\n        log.trace('processed message: '+msg.event, msg)\r\n    }\r\n    exec.now('armor-received', msg)\r\n\r\n})\r\n\r\n//log.trace('armor-meta '+event.data.data.cmd, {evt: event.data, metaCurrent: metaCurrent, metaNew: metaNew})\r\nendpoint.storageSet(event.endpoint.key,'armor-meta',metaNew)",
      "filterGeneric": "queclink-data",
      "filterType": "generic",
      "id": "697cfefdc434fb56260eff9b",
      "name": "Queclink - ASCII - Process for ARMOR",
      "rateLimit": {
        "scope": "none",
        "unit": "minute"
      },
      "type": "script"
    }
  ]
}